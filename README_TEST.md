# 血圧推定DLL テスト手順

## 概要
`dist/BloodPressureEstimation.dll`とサンプル動画`sample-data/100万画素.webm`を使用して、血圧推定機能をテストします。

## 自動セットアップ（推奨）

### 1. 自動セットアップ実行
```cmd
setup_test_environment.bat
```

このスクリプトは以下を自動実行します：
- テスト環境ディレクトリ作成
- 必要ファイルのコピー
- C#テストプログラムのコンパイル
- テスト実行の選択

### 2. テスト実行
```cmd
cd test_environment
BloodPressureTest.exe
```

## 手動セットアップ

### 1. テスト環境準備
```cmd
mkdir test_environment
cd test_environment
```

### 2. 必要ファイルコピー
```cmd
# DLL
copy ..\build\dist\BloodPressureEstimation.dll .

# Pythonモジュール
copy ..\bp_estimation_simple.py .

# C#テストコード
copy ..\BloodPressureTest.cs .

# サンプル動画
xcopy ..\sample-data sample-data\ /E /I

# modelsディレクトリ（空でも可）
mkdir models
```

### 3. C#テストプログラムコンパイル
```cmd
csc BloodPressureTest.cs
```

### 4. テスト実行
```cmd
BloodPressureTest.exe
```

## テスト内容

### テストシナリオ
1. **環境確認**
   - DLLファイルの存在確認
   - Pythonモジュールの確認
   - サンプル動画の確認

2. **DLL初期化**
   - Python環境の初期化
   - 血圧推定エンジンの起動

3. **血圧推定テスト**
   - 男性 170cm 70kg
   - 女性 160cm 55kg  
   - 男性 175cm 80kg

### 使用するサンプル動画
- ファイル: `sample-data/100万画素.webm`
- 各テストケースで同じ動画を使用
- 身長・体重・性別パラメータを変更してテスト

## 期待される結果

### 成功時の出力例
```
=== 血圧推定DLL実動テスト ===

1. 環境確認
  環境ファイル確認中...
  ✓ BloodPressureEstimation.dll 確認
  ✓ bp_estimation_simple.py 確認
  ✓ サンプル動画確認: sample-data\100万画素.webm

2. DLL初期化
  DLL初期化中...
  ✓ DLL初期化成功
  バージョン: v1.0.0-cpp-wrapper

3. サンプル動画による血圧推定テスト
  使用動画: sample-data\100万画素.webm
  動画サイズ: XXX KB

--- 男性 170cm 70kg ---
  リクエストID: 20241127123456789_9000000001_0000012345
  🚀 血圧解析開始...
  ✓ 解析リクエスト送信成功
  ⏳ 解析処理中...
  状況: processing (1s)
  📊 解析完了コールバック:
    リクエストID: 20241127123456789_9000000001_0000012345
    最高血圧: 128 mmHg
    最低血圧: 82 mmHg
    CSVデータサイズ: 1024 文字
  📋 テスト結果:
    処理時間: 2.1秒
    ✓ 成功
    最高血圧: 128 mmHg
    最低血圧: 82 mmHg
    BMI: 24.2
    血圧分類: 正常高値
    CSVファイル: result_20241127123456789_9000000001_0000012345.csv
```

## 出力ファイル

### CSVファイル
各テストで生成される血圧測定データ：
- ファイル名: `result_{リクエストID}.csv`
- 内容: PPG信号データ、ピーク情報、心拍数

### ファイル例
```csv
time,signal,peak
0.0,0.5,0
1.0,0.6,1
2.0,0.4,0
```

## トラブルシューティング

### DLL読み込みエラー
```
DLLが見つかりません
```
**解決方法**: 
- `BloodPressureEstimation.dll`が同じディレクトリにあることを確認
- 64bit環境でのテスト実行を確認

### Python初期化エラー
```
DLL初期化失敗
```
**解決方法**:
- `bp_estimation_simple.py`が同じディレクトリにあることを確認
- Python環境が正しくインストールされていることを確認

### エントリポイントエラー
```
エントリポイントが見つかりません
```
**解決方法**:
- `dumpbin /exports BloodPressureEstimation.dll`でエクスポート関数を確認
- DLLが正しくビルドされていることを確認

### 動画ファイルエラー
```
エラーコード: 1004
```
**解決方法**:
- サンプル動画ファイルのパスが正しいことを確認
- ファイルが破損していないことを確認

## 血圧分類について

### 分類基準（日本高血圧学会）
- **正常**: 収縮期 < 120 かつ 拡張期 < 80
- **正常高値**: 収縮期 120-129 かつ 拡張期 < 80
- **高血圧前症**: 収縮期 130-139 または 拡張期 80-89
- **高血圧 I度**: 収縮期 140-159 または 拡張期 90-99
- **高血圧 II度**: 収縮期 160-179 または 拡張期 100-109
- **高血圧 III度**: 収縮期 ≥ 180 または 拡張期 ≥ 110

## 注意事項

1. **医療用途禁止**: このDLLは研究・開発用途のみ
2. **精度について**: サンプル動画による簡易推定のため、実際の血圧測定とは異なる場合があります
3. **処理時間**: 動画の長さと品質により処理時間が変動します
4. **メモリ使用量**: 大きな動画ファイルの場合、十分なメモリが必要です